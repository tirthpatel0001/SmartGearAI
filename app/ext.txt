def display_gearbox_diagnosis():
    """Display gearbox defect diagnosis module"""
    st.markdown("""
        <div class="hero-header" style="padding: 40px; margin-bottom: 30px;">
            <h1>‚öôÔ∏è Gearbox Diagnosis System</h1>
            <p>AI-Powered Signal Analysis for Fault Detection & Maintenance Prediction</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("""
        <div class="info-box">
            <h4>üìã How to Use</h4>
            <p>Upload a CSV file containing vibration signal data from your gearbox sensors. Our AI will analyze the signals to detect faults and recommend maintenance actions.</p>
        </div>
    """, unsafe_allow_html=True)
    
    # File uploader
    st.markdown("<div class='input-section'>", unsafe_allow_html=True)
    st.markdown("### üì§ Upload Gearbox Signal Data")
    st.markdown("<p style='color: #7f8c8d; font-size: 0.9em;'>CSV format: Columns represent different sensor channels with vibration values</p>", unsafe_allow_html=True)
    
    uploaded_file = st.file_uploader(
        "Select a CSV file with gearbox sensor data",
        type=["csv"],
        label_visibility="collapsed"
    )
    st.markdown("</div>", unsafe_allow_html=True)
    
    if uploaded_file:
        # Save uploaded file temporarily
        with tempfile.NamedTemporaryFile(delete=False, suffix=".csv") as tmp:
            tmp.write(uploaded_file.getbuffer())
            temp_csv_path = tmp.name
        
        try:
            # Get diagnosis results
            with st.spinner("üîç Analyzing gearbox signals..."):
                # returned value is a GearboxAnalysis dataclass
                result = predict_fault_and_severity(temp_csv_path)
                fault = result.fault
                severity = result.severity
                rms = result.rms
                energy = result.energy
                recommendation = result.recommendation
                risk_label = result.risk_label
                risk_prob = result.risk_probability
                rul = result.remaining_life
                schedule = result.schedule
                health_score = result.health_score
                trend_curve = result.trend
                cost = result.failure_cost
                parts = result.spare_parts
                root_cause = result.root_cause
                chatbot_intro = result.chatbot_intro
                digital_summary = result.digital_twin_summary
            
            st.markdown("---")
            st.markdown("### üîç Diagnosis Results")
            
            # Results cards in columns
            col1, col2, col3, col4 = st.columns(4)
            
            # Fault Type
            with col1:
                st.markdown("""
                    <div class="feature-card" style="border-left-color: #FF6B6B;">
                        <h4 style="color: #FF6B6B; margin-top: 0;">üîß Fault Type</h4>
                        <p style="font-size: 1.3em; font-weight: 600; color: #2c3e50; margin: 10px 0;">
                """, unsafe_allow_html=True)
                st.markdown(fault)
                st.markdown("</p></div>", unsafe_allow_html=True)
            
            # Severity Level
            with col2:
                severity_color = "#06A77D" if severity == "Low" else "#FFB84D" if severity == "Medium" else "#FF6B6B"
                st.markdown(f"""
                    <div class="feature-card" style="border-left-color: {severity_color};">
                        <h4 style="color: {severity_color}; margin-top: 0;">üìä Severity</h4>
                        <p style="font-size: 1.3em; font-weight: 600; color: {severity_color}; margin: 10px 0;">
                            {severity}
                        </p>
                    </div>
                """, unsafe_allow_html=True)
            
            # RMS Level
            with col3:
                st.markdown("""
                    <div class="feature-card" style="border-left-color: #4ECDC4;">
                        <h4 style="color: #4ECDC4; margin-top: 0;">üìà RMS Level</h4>
                        <p style="font-size: 1.3em; font-weight: 600; color: #2c3e50; margin: 10px 0;">
                """, unsafe_allow_html=True)
                st.markdown(f"{rms:.5f}")
                st.markdown("</p></div>", unsafe_allow_html=True)
            
            # Energy Level
            with col4:
                st.markdown("""
                    <div class="feature-card" style="border-left-color: #667eea;">
                        <h4 style="color: #667eea; margin-top: 0;">‚ö° Energy</h4>
                        <p style="font-size: 1.3em; font-weight: 600; color: #2c3e50; margin: 10px 0;">
                """, unsafe_allow_html=True)
                st.markdown(f"{energy:.2f}")
                st.markdown("</p></div>", unsafe_allow_html=True)
            
            st.markdown("---")
            
            # Recommendation
            st.markdown("### üõ†Ô∏è Maintenance Recommendation")
            
            recommendation_color = "#06A77D" if "Continue" in recommendation else "#FFB84D" if "Schedule" in recommendation else "#FF6B6B"
            
            st.markdown(f"""
                <div class="feature-card" style="border-left-color: {recommendation_color}; background: linear-gradient(to right, rgba({int(recommendation_color[1:3], 16)}, {int(recommendation_color[3:5], 16)}, {int(recommendation_color[5:7], 16)}, 0.05), transparent);">
                    <h3 style="color: {recommendation_color}; margin-top: 0;">üí° {recommendation}</h3>
                </div>
            """, unsafe_allow_html=True)
            
            # Detailed Report
            st.markdown("---")
            st.markdown("### üìã Detailed Analysis Report")
            
            report_data = {
                "Parameter": ["Fault Type", "Severity Level", "RMS Vibration", "Energy Level", "Recommended Action"],
                "Value": [fault, severity, f"{rms:.5f}", f"{energy:.2f}", recommendation]
            }
            
            report_df = pd.DataFrame(report_data)
            st.dataframe(report_df, use_container_width=True, hide_index=True)
            
            # Interpretation guide
            st.markdown("### üìñ Interpretation Guide")
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("""
                    **Severity Levels:**
                    - üü¢ **Low**: Normal operation, continue monitoring
                    - üü° **Medium**: Schedule maintenance soon
                    - üî¥ **High**: Immediate action required
                """)
            
            with col2:
                st.markdown("""
                    **Signal Metrics:**
                    - **RMS**: Root Mean Square of vibration amplitude
                    - **Energy**: Total energy content in the signal
                    - Higher values indicate increased fault probability
                """)
        
        except Exception as e:
            st.error(f"‚ùå Error analyzing gearbox data: {str(e)}")
            st.markdown("<p style='color: #7f8c8d; font-size: 0.9em;'>Please ensure your CSV file has the correct format.</p>", unsafe_allow_html=True)
        
        finally:
            os.remove(temp_csv_path)
    
    else:
        st.markdown("""
            <div class="info-box" style="text-align: center; padding: 40px;">
                <h3>‚¨ÜÔ∏è Upload Gearbox Signal Data to Begin Diagnosis</h3>
                <p>CSV format with sensor vibration data columns</p>
            </div>
        """, unsafe_allow_html=True)